automation:
- alias: ZL-MR Ceiling Lights On Or Open Curtains If Entering to Room-Master Room
  id: automation.zl_mr_ceiling_lights_on_or_open_curtains_if_entering_to_room_master_room
  trigger:
    entity_id:
    - binary_sensor.master_room_entrance_motion_sensor_motion
    platform: state
    to: 'on'
  action:
  - service: automation.turn_off
    entity_id: automation.zl_mr_ceiling_lights_on_or_open_curtains_if_entering_to_room_master_room
    data:
      stop_actions: false
  - if:
    - condition: state
      entity_id: sun.sun
      state: above_horizon
    then:
    - if:
      - condition: state
        entity_id: input_boolean.always_on_constant
        state: 'on'
      then:
      - if:
        - condition: numeric_state
          entity_id: sensor.met_office_cambridge_city_airport_temperature_3_hourly
          above: '20'
        - condition: time
          after: '13:00:00'
          before: '22:00:00'
        - condition: template
          value_template: '{{ now().month > 4 and now().month < 9 }}'
        then:
          service: input_select.select_option
          target:
            entity_id: input_select.master_room_scene
          data:
            option: Ceiling Light White
        else:
          parallel:
          - service: cover.open_cover
            entity_id:
            - cover.master_room_blind
            - cover.master_room_curtain
          - if:
            - condition: state
              entity_id: input_boolean.master_room_light_in_daytime
              state: 'on'
            then:
              service: input_select.select_option
              target:
                entity_id: input_select.master_room_scene
              data:
                option: Ceiling Light White
      else:
        service: input_select.select_option
        target:
          entity_id: input_select.master_room_scene
        data:
          option: Ceiling Light White
    else:
      parallel:
      - service: input_select.select_option
        target:
          entity_id: input_select.master_room_scene
        data:
          option: All White
      - if:
        - condition: state
          entity_id: input_boolean.master_room_curtain_in_nighttime
          state: 'on'
        then:
          service: cover.open_cover
          entity_id:
          - cover.master_room_blind
          - cover.master_room_curtain
- alias: ZL-MR Lights Off If No Person-Master Room
  id: automation.zl_mr_lights_off_if_no_person_master_room
  trigger:
  - platform: state
    entity_id: input_select.master_room_occupancy
    to: Outside
  - minutes: /5
    platform: time_pattern
  condition:
  - condition: state
    entity_id: input_select.master_room_occupancy
    state: Outside
  - condition: state
    entity_id: group.master_room_motion
    state: 'off'
    for: 00:01:00
  action:
    parallel:
    - service: homeassistant.turn_on
      entity_id: automation.zl_mr_ceiling_lights_on_or_open_curtains_if_entering_to_room_master_room
    - service: cover.close_cover
      entity_id:
      - cover.master_room_blind
      - cover.master_room_curtain
    - service: homeassistant.turn_off
      entity_id:
      - media_player.master_room_tv
    - service: input_select.select_option
      target:
        entity_id: input_select.master_room_scene
      data:
        option: All Off
- alias: ZL-MR LED On for 3 Min if Walking In the Dark-Master Room
  mode: restart
  trigger:
  - entity_id:
    - binary_sensor.master_room_entrance_motion_sensor_motion
    - binary_sensor.master_room_stair_motion_sensor_motion
    - binary_sensor.master_room_dressing_table_motion_sensor_motion
    - binary_sensor.master_room_tv_motion_sensor_motion
    - binary_sensor.master_room_drawer_motion_sensor_motion
    - binary_sensor.master_toilet_dressing_room_motion_sensor_motion
    platform: state
    to: 'on'
  condition:
  - condition: state
    entity_id: input_select.indoor_brightness
    state: dark
  - entity_id:
    - light.master_room_drawer_led
    - light.master_room_tv_led
    - light.master_room_bed_led
    - light.master_room_ceiling_light
    condition: state
    state: 'off'
  action:
  - service: light.turn_on
    entity_id:
    - light.master_room_drawer_led
    - light.master_room_tv_led
    - light.master_room_bed_led
    data:
      brightness_pct: 40
  - delay: 00:03:00
  - service: homeassistant.turn_off
    entity_id:
    - light.master_room_drawer_led
    - light.master_room_tv_led
    - light.master_room_bed_led
  id: automation.zl_mr_led_on_for_3_min_if_walking_in_the_dark_master_room
- alias: ZH-MR Heating Schedule On If Staying In the Room-Master Room
  id: automation.zh_mr_heating_schedule_on_if_staying_in_the_room_master_room
  trigger:
  - platform: state
    entity_id: input_select.master_room_occupancy
    from:
    - Just Entered
    - Outside
    to: Stayed Inside
  action:
  - if:
    - condition: not
      conditions:
      - condition: state
        entity_id: climate.master_room
        state: heat
    then:
    - service: climate.set_hvac_mode
      data:
        hvac_mode: heat
      target:
        entity_id: climate.master_room
    - service: switch.turn_on
      target:
        entity_id: switch.schedule_master_room_temperature
- alias: ZH-MR Heating Schedule Off If People Left the Room-Master Room
  id: automation.zh_mr_heating_schedule_off_if_people_left_the_room_master_room
  trigger:
  - platform: state
    entity_id: input_select.master_room_occupancy
    to: Outside
  - minutes: /5
    platform: time_pattern
  action:
  - condition: state
    entity_id: input_select.master_room_occupancy
    state: Outside
  - condition: state
    entity_id: input_boolean.master_room_heating_override
    state: 'off'
  - service: climate.set_hvac_mode
    data:
      hvac_mode: 'off'
    target:
      entity_id: climate.master_room
  - service: switch.turn_off
    target:
      entity_id: switch.schedule_master_room_temperature
- alias: ZH-MR Heating Manual Override-Master Room
  mode: restart
  trigger:
  - platform: state
    entity_id: input_boolean.master_room_heating_override
  action:
  - if:
    - condition: state
      entity_id: input_boolean.master_room_heating_override
      state: 'on'
    then:
    - service: automation.trigger
      entity_id:
      - automation.zh_mr_heating_schedule_on_if_staying_in_the_room_master_room
    else:
    - service: automation.trigger
      entity_id:
      - automation.zh_mr_heating_schedule_off_if_people_left_the_room_master_room
  id: automation.zh_mr_heating_manual_override_master_room
- alias: ZH-MR Heating Manual Override Timeout in Few Hours-Master Room
  trigger:
  - platform: state
    entity_id: input_boolean.master_room_heating_override
    from: 'off'
    to: 'on'
  action:
  - delay:
      hours: 3
      minutes: 0
      seconds: 0
      milliseconds: 0
  - service: homeassistant.turn_off
    entity_id: input_boolean.master_room_heating_override
  id: automation.zh_mr_heating_manual_override_timeout_in_few_hours_master_room
- alias: ZH-MR Valve Calibrate Temperature Using External Sensor-Master Room
  use_blueprint:
    path: calibrate_valve_temperature.yaml
    input:
      tado_valve_entity: climate.master_room
      external_temperature_sensor_entity: sensor.master_room_temperature_sensor
  id: automation.zh_mr_valve_calibrate_temperature_using_external_sensor_master_room
- alias: ZLB-MR Remote Button - Single - Applies Different Scenes (State Machine)-Master Room
  trigger:
  - platform: state
    entity_id:
    - sensor.master_room_button_1
    - sensor.master_room_button_2
    to:
    - single
    - '1'
  mode: queued
  action:
  - choose:
    - conditions:
        condition: state
        entity_id: input_select.master_room_scene
        state: All Off
      sequence:
        service: input_select.select_option
        target:
          entity_id: input_select.master_room_scene
        data:
          option: All White
    - conditions:
        condition: state
        entity_id: input_select.master_room_scene
        state: All White
      sequence:
        service: input_select.select_option
        target:
          entity_id: input_select.master_room_scene
        data:
          option: Lamp LED White
    - conditions:
        condition: state
        entity_id: input_select.master_room_scene
        state: Lamp LED White
      sequence:
        service: input_select.select_option
        target:
          entity_id: input_select.master_room_scene
        data:
          option: Hue
    - conditions:
        condition: state
        entity_id: input_select.master_room_scene
        state: Hue
      sequence:
        service: input_select.select_option
        target:
          entity_id: input_select.master_room_scene
        data:
          option: Night Mode
    - conditions:
        condition: state
        entity_id: input_select.master_room_scene
        state: Night Mode
      sequence:
        service: input_select.select_option
        target:
          entity_id: input_select.master_room_scene
        data:
          option: All Off
    default:
      service: input_select.select_option
      target:
        entity_id: input_select.master_room_scene
      data:
        option: All Off
  id: automation.zlb_mr_remote_button_single_applies_different_scenes_state_machine_master_room
- alias: ZLB-MR Applies Different Scenes Based on Scene Selections (State Execution)-Master Room
  trigger:
  - platform: state
    entity_id: input_select.master_room_scene
  mode: queued
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: input_select.master_room_scene
        state: All White
      sequence:
      - parallel:
        - service: homeassistant.turn_on
          entity_id:
          - light.master_room_lamp_1
          - light.master_room_lamp_2
          - light.master_room_ceiling_light
          - light.master_room_drawer_led
          - light.master_room_tv_led
          - light.master_room_bed_led
        - service: samsungtv_smart.select_picture_mode
          data:
            entity_id:
            - media_player.master_room_tv
            picture_mode: Standard
    - conditions:
      - condition: state
        entity_id: input_select.master_room_scene
        state: Ceiling Light White
      sequence:
      - parallel:
        - service: homeassistant.turn_off
          entity_id:
          - light.master_room_drawer_led
          - light.master_room_tv_led
          - light.master_room_bed_led
          - light.master_room_lamp_1
          - light.master_room_lamp_2
        - service: homeassistant.turn_on
          entity_id:
          - light.master_room_ceiling_light
        - service: samsungtv_smart.select_picture_mode
          data:
            entity_id:
            - media_player.master_room_tv
            picture_mode: Standard
    - conditions:
      - condition: state
        entity_id: input_select.master_room_scene
        state: Lamp LED White
      sequence:
      - parallel:
        - service: homeassistant.turn_off
          entity_id:
          - light.master_room_ceiling_light
        - service: homeassistant.turn_on
          entity_id:
          - light.master_room_lamp_1
          - light.master_room_lamp_2
          - light.master_room_drawer_led
          - light.master_room_tv_led
          - light.master_room_bed_led
        - service: samsungtv_smart.select_picture_mode
          data:
            entity_id:
            - media_player.master_room_tv
            picture_mode: Standard
    - conditions:
      - condition: state
        entity_id: input_select.master_room_scene
        state: LED White
      sequence:
      - parallel:
        - service: homeassistant.turn_off
          entity_id:
          - light.master_room_ceiling_light
          - light.master_room_lamp_1
          - light.master_room_lamp_2
        - service: homeassistant.turn_on
          entity_id:
          - light.master_room_drawer_led
          - light.master_room_tv_led
          - light.master_room_bed_led
        - service: samsungtv_smart.select_picture_mode
          data:
            entity_id:
            - media_player.master_room_tv
            picture_mode: Natural
    - conditions:
      - condition: state
        entity_id: input_select.master_room_scene
        state: Hue
      sequence:
      - service: light.turn_on
        entity_id:
        - light.master_room_lamp_1
        - light.master_room_lamp_2
        - light.master_room_drawer_led
        - light.master_room_tv_led
        - light.master_room_bed_led
        data:
          brightness_pct: 100
      - service: pyscript.set_rgb_light_list
        data:
          light_list:
          - light.master_room_lamp_1
          - light.master_room_lamp_2
          - light.master_room_ceiling_light
          - light.master_room_drawer_led
          - light.master_room_tv_led
          - light.master_room_bed_led
      - service: samsungtv_smart.select_picture_mode
        data:
          entity_id:
          - media_player.master_room_tv
          picture_mode: Standard
    - conditions:
      - condition: state
        entity_id: input_select.master_room_scene
        state: Night Mode
      sequence:
      - parallel:
        - service: homeassistant.turn_on
          entity_id: scene.master_room_night_mode
    - conditions:
      - condition: state
        entity_id: input_select.master_room_scene
        state: Dark Night Mode
      sequence:
      - parallel:
        - service: homeassistant.turn_on
          entity_id: scene.master_room_dark_night_mode
    - conditions:
      - condition: state
        entity_id: input_select.master_room_scene
        state: All Off
      sequence:
      - parallel:
        - service: homeassistant.turn_off
          entity_id:
          - light.master_room_lamp_1
          - light.master_room_lamp_2
          - light.master_room_ceiling_light
          - light.master_room_drawer_led
          - light.master_room_tv_led
          - light.master_room_bed_led
  id: automation.zlb_mr_applies_different_scenes_based_on_scene_selections_state_execution_master_room
- alias: ZLB-MR Remote Button - Double - Toggle Lamps-Master Room
  trigger:
  - platform: state
    entity_id:
    - sensor.master_room_button_1
    - sensor.master_room_button_2
    to:
    - double
    - '2'
  action:
  - service: homeassistant.toggle
    entity_id:
    - light.master_room_lamp_1
    - light.master_room_lamp_2
  id: automation.zlb_mr_remote_button_double_toggle_lamps_master_room
- alias: ZLB-MR Remote Button - Triple - Toggle Ceiling Lights-Master Room
  trigger:
  - platform: state
    entity_id:
    - sensor.master_room_button_1
    - sensor.master_room_button_2
    to:
    - triple
    - '3'
  action:
  - service: homeassistant.toggle
    entity_id:
    - light.master_room_ceiling_light
  id: automation.zlb_mr_remote_button_triple_toggle_ceiling_lights_master_room
- alias: ZLB-MR Remote Button - Long - Toggle LEDs-Master Room
  trigger:
  - platform: state
    entity_id:
    - sensor.master_room_button_1
    - sensor.master_room_button_2
    to: hold
  action:
  - service: homeassistant.toggle
    entity_id:
    - light.master_room_drawer_led
    - light.master_room_tv_led
    - light.master_room_bed_led
  id: automation.zlb_mr_remote_button_long_toggle_leds_master_room
- alias: ZLB-MR Wall Switch-Single Press - Toggle Ceiling Light-Master Room
  trigger:
  - platform: state
    entity_id:
    - sensor.master_room_entrance_wall_button
    to:
    - '1'
    - single
    - single_left
    - single_right
    - single_center
    - button_1_single
    - button_2_single
    - button_3_single
  action:
  - service: homeassistant.toggle
    entity_id:
    - light.master_room_ceiling_light
  id: automation.zlb_mr_wall_switch_single_press_toggle_ceiling_light_master_room
- alias: ZLB-MR Wall Switch - Double Press - Leave Room and Turn Off Everything-Master Room
  trigger:
  - platform: state
    entity_id:
    - sensor.master_room_entrance_wall_button
    to:
    - '2'
    - double
    - double_left
    - double_right
    - double_center
  action:
  - service: automation.trigger
    entity_id:
    - automation.zl_mr_lights_off_if_no_person_master_room
    - automation.zh_mr_heating_schedule_off_if_people_left_the_room_master_room
  - service: input_select.select_option
    target:
      entity_id: input_select.master_room_occupancy
    data:
      option: Outside
  id: automation.zlb_mr_wall_switch_double_press_leave_room_and_turn_off_everything_master_room
- alias: ZOc-MR Occupancy Update-Master Room
  trigger:
  - entity_id: group.master_room_motion
    platform: state
    to: 'on'
  - entity_id: group.master_room_motion
    platform: state
    to: 'off'
    for: 05:00:00
  - minutes: /5
    platform: time_pattern
  action:
  - service: pyscript.room_occupancy_state_machine
    data:
      occupancy_entity_str: input_select.master_room_occupancy
      motion_str: group.master_room_motion
      motion_on_ratio_for_x_min_str: sensor.master_room_motion_on_ratio_for_last_4_minutes
      motion_on_ratio_for_2x_min_str: sensor.master_room_motion_on_ratio_for_last_8_minutes
      room_type: bedroom
  id: automation.zoc_mr_occupancy_update_master_room
input_select:
  master_room_scene:
    name: Master Room Scene
    options:
    - Hue
    - Night Mode
    - Dark Night Mode
    - Lamp LED White
    - LED White
    - All White
    - Ceiling Light White
    - All Off
  master_room_occupancy:
    name: Master Room Occupancy
    options:
    - Outside
    - Just Entered
    - Stayed Inside
    - In Sleep
sensor:
- platform: history_stats
  name: Master Room Motion On Ratio For Last 4 Minutes
  entity_id: group.master_room_motion
  state: 'on'
  type: ratio
  duration:
    minutes: '4'
  end: '{{ (now() | as_timestamp) | as_datetime | as_local }}'
- platform: history_stats
  name: Master Room Motion On Ratio For Last 8 Minutes
  entity_id: group.master_room_motion
  state: 'on'
  type: ratio
  duration:
    minutes: '8'
  end: '{{ (now() | as_timestamp) | as_datetime | as_local }}'
input_boolean:
  master_room_heating_override:
    name: Master Room Heating Override
    initial: 'off'
  master_room_light_in_daytime:
    name: Master Room Light in Daytime Enable
  master_room_curtain_in_nighttime:
    name: Master Room Curtain In Nighttime Enable
switch:
- platform: group
  name: Master Room Wall Switch 1
  entities: switch.0x04cf8cdf3c7ad638_channel_1
- platform: group
  name: Master Room Wall Switch 2
  entities: switch.0x04cf8cdf3c7ad638_channel_2
- platform: group
  name: Master Room Wall Switch 3
  entities: switch.0x04cf8cdf3c7ad638_channel_3
template:
- sensor:
  - name: Master Room Wall Button
    state: '{{states.sensor["0x04cf8cdf3c7ad638_action"].state}}'
- sensor:
  - name: Master Room TV Motion Sensor Light
    unit_of_measurement: lx
    state: '{{states.sensor["0x00158d0005228ba8_illuminance"].state}}'
- sensor:
  - name: Master Room TV Motion Sensor Battery
    unit_of_measurement: '%'
    state: '{{states.sensor["0x00158d0005228ba8_battery"].state}}'
- sensor:
  - name: Master Room Occupancy Sensor Light
    unit_of_measurement: lx
    state: '{{states.sensor["dced830908fb_illuminance"].state}}'
binary_sensor:
- platform: group
  name: Master Room TV Motion Sensor Motion
  entities: binary_sensor.0x00158d0005228ba8_motion
- platform: group
  name: Master Room Occupancy Sensor Occupancy
  entities: binary_sensor.dced830908fb_occupancy
light: []
group:
  master_room_occupancy_group:
    name: Master Room Occuapancy Group
    entities:
    - input_select.master_room_occupancy
    - group.master_room_motion
    - binary_sensor.master_room_bed_motion_sensor_motion
    - binary_sensor.master_room_entrance_motion_sensor_motion
    - binary_sensor.master_room_stair_motion_sensor_motion
    - binary_sensor.master_room_dressing_table_motion_sensor_motion
    - binary_sensor.master_room_tv_motion_sensor_motion
    - binary_sensor.master_room_drawer_motion_sensor_motion
    - binary_sensor.master_toilet_dressing_room_motion_sensor_motion
  master_room_motion:
    name: Master Room Motion
    entities:
    - binary_sensor.master_room_bed_motion_sensor_motion
    - binary_sensor.master_room_entrance_motion_sensor_motion
    - binary_sensor.master_room_stair_motion_sensor_motion
    - binary_sensor.master_room_dressing_table_motion_sensor_motion
    - binary_sensor.master_room_tv_motion_sensor_motion
    - binary_sensor.master_room_drawer_motion_sensor_motion
    - binary_sensor.master_toilet_dressing_room_motion_sensor_motion
  master_room_auto_gen_automations:
    name: Master Room Auto-gen Automations
    entities:
    - input_boolean.master_room_light_in_daytime
    - input_boolean.master_room_curtain_in_nighttime
    - automation.zl_mr_ceiling_lights_on_or_open_curtains_if_entering_to_room_master_room
    - automation.zl_mr_lights_off_if_no_person_master_room
    - automation.zl_mr_led_on_for_3_min_if_walking_in_the_dark_master_room
    - automation.zh_mr_heating_schedule_on_if_staying_in_the_room_master_room
    - automation.zh_mr_heating_schedule_off_if_people_left_the_room_master_room
    - automation.zh_mr_heating_manual_override_master_room
    - automation.zh_mr_heating_manual_override_timeout_in_few_hours_master_room
    - automation.zh_mr_valve_calibrate_temperature_using_external_sensor_master_room
    - automation.zlb_mr_remote_button_single_applies_different_scenes_state_machine_master_room
    - automation.zlb_mr_applies_different_scenes_based_on_scene_selections_state_execution_master_room
    - automation.zlb_mr_remote_button_double_toggle_lamps_master_room
    - automation.zlb_mr_remote_button_triple_toggle_ceiling_lights_master_room
    - automation.zlb_mr_remote_button_long_toggle_leds_master_room
    - automation.zlb_mr_wall_switch_single_press_toggle_ceiling_light_master_room
    - automation.zlb_mr_wall_switch_double_press_leave_room_and_turn_off_everything_master_room
    - automation.zoc_mr_occupancy_update_master_room
