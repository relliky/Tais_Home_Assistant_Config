###########################################
#
# Integration Instantiated in yaml
#
###########################################

# Use smartthings to port MagicHome Pro LEDs
## Added MagicHome LEDs
## This is a third-party custom component on flux_led
## instead of the official one from HA
#light magic_home:
#   - platform: flux_led
#     devices:
#       192.168.1.54:
#         name: En-suite Room Bed LED Flux LED
#         mode: "rgb"

###########################################
#
# Custom Entities
#
###########################################

# Custom Thermostat
climate:
  - platform: generic_thermostat
    name: En-suite Room Air Conditioner
    heater: switch.air_conditioner
    ac_mode: true
    target_sensor: sensor.en_suite_room_temperature_sensor
    precision: 0.5
    min_temp: 10
    max_temp: 25
    cold_tolerance: 0.1
    hot_tolerance: 0.1
    initial_hvac_mode: "off"

# Room Motion
group:
  en_suite_room_motion:
    name: En-suite Room Motion
    entities:
      - binary_sensor.en_suite_room_bed_motion_sensor_motion
      - binary_sensor.en_suite_room_entrance_motion_sensor_motion
      #- binary_sensor.kes_desk_motion_sensor_motion
      #- binary_sensor.tais_desk_motion_sensor_motion

  en_suite_room_appliances:
    name: En-suite Room Appliances
    entities:
      - light.en_suite_room_ceiling_light
      - light.en_suite_room_lamp_1
      - light.en_suite_room_lamp_2
      #- light.tais_desk_lamps
      #- switch.tais_desk_screen_led
      #- light.kes_desk_lamps
      #- switch.kes_desk_screen_led
      - light.en_suite_room_bed_led
      - climate.en_suite_room

# Custom Variables
input_boolean:
  # Spare Room Usage
  en_suite_room_guests_use_this_room:
    name: "En-suite Room Guests Use This Room"

  # Custom Thermostat Switch
  # en_suite_room_valve_switch:
  #   name: "En-suite Room Valve Switch"

  # First Time Presence in a Room
  en_suite_room_short_presence:
    name: "En-suite Room Short Presence"
    initial: "off"

# Valve Setting
input_text:
  en_suite_room_valve_log:
    name: En-suite Room Valve Log

input_number:
  en_suite_room_default_temperature:
    name: En-suite Room Default Temperature
    min: 10
    max: 25
    step: 0.5

###############################################
#
# Scripts
#
###############################################
script:
  en_suite_room_all_lights_turn_on:
    alias: En-suite Room All Light Turn On
    mode: parallel
    max: 100
    sequence:
      - service: light.turn_on
        entity_id:
          - light.en_suite_room_ceiling_light
          - light.en_suite_room_bed_led
          #- switch.en_suite_room_bedside_lamp

  en_suite_room_all_lights_turn_off:
    alias: En-suite Room All Light Turn Off
    mode: parallel
    max: 100
    sequence:
      - service: light.turn_off
        entity_id:
          - light.en_suite_room_ceiling_light
          - light.en_suite_room_bed_led
          #- switch.en_suite_room_bedside_lamp

###############################################
#
# Automations:
# - Lighting/Heating automation based on motion sensors
# - Actions based on buttons
# - Maintaince on bedroom automation based on presence
#
###############################################

automation:
  ###############################################
  # Heating Automation based on motion sensors
  ###############################################
#  - alias: H-ER En-suite Room Lights/Heating Off If No Person
#    id: "1603640029651"
#    description: ""
#    trigger:
#      - entity_id: group.en_suite_room_motion
#        platform: state
#        to: "off"
#        for: 00:15:00
#    condition:
#      - condition: or
#        conditions:
#          # IF - in daytime, turn off lighting/heating if no person for 15 min
#          - condition: and
#            conditions:
#              - after: "10:00:00"
#                before: "22:00:00"
#                condition: time
#              - condition: state
#                entity_id: group.en_suite_room_motion
#                for: 00:15:00
#                state: "off"
#          - condition: and
#            conditions:
#              - condition: state
#                entity_id: group.en_suite_room_motion
#                state: "off"
#                for: 02:00:00
#              - condition: state
#                entity_id: input_boolean.en_suite_room_guests_use_this_room
#                state: "on"
#    action:
#      # Turn off room thermostat and Turn On Auto Heating
#      - service: automation.turn_off
#        entity_id: automation.en_suite_room_heating_scheduler
#      - service: climate.set_hvac_mode
#        entity_id: climate.en_suite_room
#        data:
#          hvac_mode: "off"
#      - service: automation.turn_on
#        entity_id: automation.en_suite_room_heating_on_if_people_present
#      # Clear flags
#      - service: input_boolean.turn_off
#        entity_id: input_boolean.en_suite_room_short_presence
#
#  - alias: H-ER En-suite Room Heating On If People Present
#    id: "1599909943111"
#    description: "automation.en_suite_room_heating_on_if_people_present"
#    use_blueprint:
#      path: room_delayed_action.yaml
#      input:
#        binary_sensor_motion_sensors: group.en_suite_room_motion
#        input_boolean_short_presence: input_boolean.en_suite_room_short_presence
#        automation_this_automation_entity: automation.en_suite_room_heating_on_if_people_present
#        automations_to_be_triggered_and_on: automation.en_suite_room_heating_scheduler
#
#  - alias: H-ER En-suite Room Heating Scheduler
#    id: "1515909948789"
#    description: "automation.en_suite_room_heating_scheduler"
#    trigger:
#      - platform: state
#        entity_id: input_number.en_suite_room_default_temperature
#    action:
#      - data:
#          temperature: "{{states('input_number.en_suite_room_default_temperature')}}"
#          hvac_mode: "heat"
#        entity_id: climate.en_suite_room
#        service: climate.set_temperature

  - alias: H-ER En-suite Room Valve Calibrate Temperature
    id: "1343567382451"
    use_blueprint:
      path: calibrate_valve_temperature.yaml
      input:
        tado_valve_entity: climate.en_suite_room
        external_temperature_sensor_entity: sensor.en_suite_room_temperature_sensor
        log_input_text_entity: input_text.en_suite_room_valve_log


  ###############################################
  # Actions based on buttons
  ###############################################

  # En-suite Room
  #- alias: B-ER En-suite Room Wall Switch - Single Press - Turn On En-suite Room Lights/Turn Off All Lights
  #  trigger:
  #  - platform: state
  #    entity_id: sensor.en_suite_room_wall_button
  #    to: single
  #  action:
  #  - choose:
  #    # IF - all lights off - turn on ceiling light
  #    - conditions:
  #      - condition: and
  #        conditions:
  #        - condition: state
  #          entity_id: switch.en_suite_room_ceiling_light
  #          state: 'off'
  #        - condition: state
  #          entity_id: switch.en_suite_room_bedside_lamp
  #          state: 'off'
  #        - condition: state
  #          entity_id: light.en_suite_toilet_ceiling_light
  #          state: 'off'
  #      sequence:
  #        - service: switch.turn_on
  #          entity_id: switch.en_suite_room_ceiling_light
  #    # ELSE - some lights on - turn off all lights
  #    default:
  #      - service: switch.turn_off
  #        entity_id:
  #        - switch.en_suite_room_ceiling_light
  #        - switch.en_suite_room_bedside_lamp
  #      - service: light.turn_off
  #        entity_id:
  #        - light.en_suite_toilet_ceiling_light
#
#  - alias: B-ER En-suite Room Wall/Bed Button  - Single Press - Toggle Ceiling Lights
#    trigger:
#      - platform: state
#        entity_id:
#          - sensor.en_suite_room_wall_button
#        to: "single"
#    action:
#      - service: light.toggle
#        entity_id:
#          - light.en_suite_room_ceiling_light
#
#  - alias: B-ER Tai's Desk Button  - Single Press - Toggle Bed LED
#    trigger:
#      - platform: state
#        entity_id: sensor.guest_room_button
#        to: "single"
#    action:
#      - service: light.toggle
#        entity_id:
#          - light.en_suite_room_bed_led
#
#  - alias: B-ER Tai's Desk Button - Double Press - Toggle Tai's Desk Lamp
#    trigger:
#      - platform: state
#        entity_id: sensor.guest_room_button
#        to: "double"
#    action:
#      - service: light.toggle
#        entity_id: light.tais_desk_lamps

  ######################################################
  # Maintaince on bedroom automation based on presence
  ######################################################
  - alias: P-ER En-suite Room Disable The Entering Room Automation If People Present
    trigger:
      - entity_id: binary_sensor.en_suite_room_bed_motion_sensor_motion
        platform: state
        from: "off"
        to: "on"
    condition: []
    action:
      - delay: 00:00:30
      - service: automation.turn_off
        entity_id:
          - automation.l_er_en_suite_room_ceiling_lights_on_or_open_curtains_if_entering_to_room
      # Short presence machanism requires to turn off auto-heating late
      - delay: 00:03:00
      - service: automation.turn_off
        entity_id:
          - automation.en_suite_room_heating_on_if_people_present
